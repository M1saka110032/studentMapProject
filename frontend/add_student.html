<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { margin-bottom: 20px; }
        form { max-width: 600px; }
        label { display: block; margin-top: 10px; }
        input, select, button { width: 100%; padding: 8px; margin-top: 5px; }

        .status-option {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            margin-right: 10px;
            cursor: pointer;
        }
        .current { background-color: green; color: white; }
        .past { background-color: red; color: white; }

        #school-search-results {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
        }
        .school-item { padding: 5px; cursor: pointer; }
        .school-item:hover { background-color: #f0f0f0; }

        #photo-preview {
            margin-top: 10px;
            max-width: 150px;
            max-height: 150px;
            display: block;
        }

        .achievement-row {
            display: flex;
            gap: 8px;
            margin-top: 6px;
        }
        .achievement-row input {
            flex: 1;
        }
        .achievement-row button {
            width: auto;
        }
    </style>
</head>
<body>

<h1 id="form-title">Add / Edit Student</h1>

<form id="student-form">

    <label>Name:
        <input type="text" id="name" required />
    </label>

    <label>Age:
        <select id="age"></select>
    </label>

    <label>Grade:
        <select id="grade"></select>
    </label>

    <label>Status:
        <div>
            <span id="status-current" class="status-option current">Currently Enrolled</span>
            <span id="status-past" class="status-option past">Past Student</span>
        </div>
    </label>

    <label>School:
        <input type="text" id="school-search" placeholder="Search school..." autocomplete="off" />
        <div id="school-search-results"></div>
        <input type="hidden" id="school-id" />
        <input type="hidden" id="school-lat" />
        <input type="hidden" id="school-lng" />
    </label>

    <label>Photo:
        <input type="file" id="photo" accept="image/*" />
        <img id="photo-preview" />
    </label>

    <!-- ACHIEVEMENTS -->
    <label>Achievements:</label>
    <div id="achievements-list"></div>
    <button type="button" onclick="addAchievement()">+ Add Achievement</button>

    <br><br>
    <button type="submit">Save</button>
</form>

<script>
/* ---------------- BASIC SETUP ---------------- */
const params = new URLSearchParams(window.location.search);
const studentId = params.get("id");

const ageSelect = document.getElementById("age");
const gradeSelect = document.getElementById("grade");

for (let i = 10; i <= 30; i++) {
    ageSelect.innerHTML += `<option value="${i}">${i}</option>`;
}

/* ---------------- STATUS ---------------- */
let currentStatus = "current";
document.getElementById("status-current").onclick = () => currentStatus = "current";
document.getElementById("status-past").onclick = () => currentStatus = "past";

/* ---------------- ACHIEVEMENTS ---------------- */
function addAchievement(title = "", id = "") {
    const row = document.createElement("div");
    row.className = "achievement-row";
    row.innerHTML = `
        <input type="text" value="${title}" data-id="${id}" placeholder="Achievement title" />
        <button type="button" onclick="this.parentElement.remove()">âœ•</button>
    `;
    document.getElementById("achievements-list").appendChild(row);
}

function collectAchievements() {
    return [...document.querySelectorAll(".achievement-row input")]
        .map(i => ({
            id: i.dataset.id || null,
            title: i.value.trim()
        }))
        .filter(a => a.title);
}

/* ---------------- SCHOOL SEARCH ---------------- */
const schoolInput = document.getElementById("school-search");
const resultsDiv = document.getElementById("school-search-results");

schoolInput.addEventListener("input", () => {
    const q = schoolInput.value.trim();
    if (!q) return resultsDiv.innerHTML = "";

    fetch(`/search?q=${q}`)
        .then(res => res.json())
        .then(data => {
            resultsDiv.innerHTML = "";
            data.filter(x => x.type === "school").forEach(s => {
                const d = document.createElement("div");
                d.className = "school-item";
                d.textContent = s.name;
                d.onclick = () => {
                    schoolInput.value = s.name;
                    document.getElementById("school-id").value = s.id;
                    resultsDiv.innerHTML = "";
                };
                resultsDiv.appendChild(d);
            });
        });
});

/* ---------------- EDIT MODE ---------------- */
if (studentId) {
    fetch(`/students/${studentId}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("form-title").innerText = "Edit Student";
            document.getElementById("name").value = data.student.name;
            ageSelect.value = data.student.age;
            gradeSelect.value = data.student.grade;

            data.achievements.forEach(a => addAchievement(a.title, a.id));
        });
}

/* ---------------- SUBMIT ---------------- */
document.getElementById("student-form").onsubmit = e => {
    e.preventDefault();

    const fd = new FormData();
    fd.append("name", name.value);
    fd.append("age", ageSelect.value);
    fd.append("grade", gradeSelect.value);
    fd.append("status", currentStatus);
    fd.append("school_id", document.getElementById("school-id").value);
    fd.append("achievements", JSON.stringify(collectAchievements()));

    if (photo.files[0]) fd.append("photo", photo.files[0]);

    fetch(studentId ? `/students/${studentId}` : "/students", {
        method: studentId ? "PUT" : "POST",
        body: fd
    }).then(r => {
        if (r.ok) alert("Saved successfully");
        else alert("Save failed");
    });
};
</script>

</body>
</html>
