<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Detail</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { margin-bottom: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; }
        th { background-color: #f5f5f5; }
        #back { margin-bottom: 20px; padding: 8px 16px; font-size: 16px; cursor: pointer; }
        ul { margin-top: 10px; }
        .empty { color: #888; font-style: italic; }
        #student-photo { max-width: 150px; max-height: 150px; display: block; margin-top: 10px; }
    </style>
</head>
<body>

<button id="back">Back</button>

<h1 id="student-name">Loading...</h1>

<p><strong>Age:</strong> <span id="student-age"></span></p>
<p><strong>Grade:</strong> <span id="student-grade"></span></p>
<p><strong>Photo:</strong> <br><img id="student-photo" src="/static/avatar/default_avatar.png" alt="No photo" /></p>

<h2>Achievements</h2>
<ul id="achievements-list"></ul>
<p id="no-achievements" class="empty" style="display:none;">No achievements yet.</p>

<h2>Schools</h2>
<table>
    <thead>
        <tr>
            <th>School</th>
            <th>Status</th>
            <th>Start Year</th>
            <th>End Year</th>
        </tr>
    </thead>
    <tbody id="schools-table"></tbody>
</table>

<script>
    // 返回上一页
    document.getElementById("back").onclick = () => { history.back(); };

    // 获取 student id
    const params = new URLSearchParams(window.location.search);
    const studentId = params.get("id");

    // 获取学生详情
    fetch(`/students/${studentId}`)
        .then(async res => {
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text}`);
            }
            return res.json();
        })
        .then(data => {
            // 学生基本信息
            document.getElementById("student-name").textContent = data.student.name;
            document.getElementById("student-age").textContent = data.student.age;
            document.getElementById("student-grade").textContent = data.student.grade;

            const photoImg = document.getElementById("student-photo");
            if (data.student.photo_path) {
                // ⚡ 修复点：确保图片路径以 /static/ 开头
                photoImg.src = data.student.photo_path.startsWith("/static/") 
                               ? data.student.photo_path 
                               : `/static/${data.student.photo_path}`;
            } else {
                photoImg.src = "/static/photos/default_avatar.png";
                photoImg.alt = "No photo available";
            }

            // 成就
            const achList = document.getElementById("achievements-list");
            const emptyTip = document.getElementById("no-achievements");
            if (!data.achievements || data.achievements.length === 0) {
                emptyTip.style.display = "block";
            } else {
                emptyTip.style.display = "none";
                data.achievements.forEach(a => {
                    const li = document.createElement("li");
                    li.textContent = a.title;
                    achList.appendChild(li);
                });
            }

            // 学校信息
            const table = document.getElementById("schools-table");
            table.innerHTML = "";
            if (data.schools && data.schools.length > 0) {
                data.schools.forEach(s => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${s.name}</td>
                        <td>${s.status || ""}</td>
                        <td>${s.start_year || ""}</td>
                        <td>${s.end_year || ""}</td>
                    `;
                    table.appendChild(row);
                });
            } else {
                const row = document.createElement("tr");
                row.innerHTML = `<td colspan="4" class="empty">No schools enrolled</td>`;
                table.appendChild(row);
            }
        })
        .catch(err => {
            console.error("Failed to fetch student:", err);
            document.getElementById("student-name").textContent = "Failed to load student info";
        });
</script>

</body>
</html>
